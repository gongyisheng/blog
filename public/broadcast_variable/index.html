<!DOCTYPE html>
<html lang="en-us"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   <meta name="description" content="Observation

Spark cluster master node OOM

Master node shutdown due to OOM. Error log:
INFO Data stored in hdfs:///XXXX
INFO XXXXX updated
INFO Data has XXXXX records
INFO Data stored in hdfs:///XXXX
INFO XXXXX updated

java.lang.OutOfMemoryError: Java heap space
-XX:OnOutOfMemoryError=&ldquo;kill -9 %p&rdquo;
Executing /bin/sh -c &ldquo;kill -9 *****&rdquo;&hellip;

Spark cluster worker node shutdown

Worker nodes worked well until driver shutdown. Error log:
ERROR YarnCoarseGrainedExecutorBackend: Executor self-exiting due to : Driver ip----.ec2.internal:***** disassociated! Shutting down.
INFO MemoryStore: MemoryStore cleared
INFO BlockManager: BlockManager stopped
ERROR CoarseGrainedExecutorBackend: RECEIVED SIGNAL TERM">  

  <title>
    
      MySQL connection deadlock
    
  </title>


  <link rel="shortcut icon" type="image/x-icon" href="/" />
  
  
  
  <link rel="stylesheet" href="/css/main.900100e9dbee2d56c58fac8bb717037cae7e26a9c36c29d2ff587bdd65f0cbbe510b41d81a3bb234919cdfdc7550d786b2fab70c8fc507772d732fe097106d12.css" integrity="sha512-kAEA6dvuLVbFj6yLtxcDfK5&#43;JqnDbCnS/1h73WXwy75RC0HYGjuyNJGc39x1UNeGsvq3DI/FB3ctcy/glxBtEg==" />
  
</head>
<body a="auto">
        <main class="page-content" aria-label="Content">
            <div class="w">
<a href="/">..</a>


<article>
    <p class="post-meta">
        <time datetime="2023-02-10 12:00:00 -0700 -0700">
            2023-02-10
        </time>
    </p>

    <h1>MySQL connection deadlock</h1>

    

    <p>Observation</p>
<ol>
<li>Spark cluster master node OOM</li>
</ol>
<p>Master node shutdown due to OOM. Error log:</p>
<p>INFO Data stored in hdfs:///XXXX
INFO XXXXX updated
INFO Data has XXXXX records
INFO Data stored in hdfs:///XXXX
INFO XXXXX updated</p>
<h1></h1>
<h1 id="javalangoutofmemoryerror-java-heap-space">java.lang.OutOfMemoryError: Java heap space</h1>
<h1 id="-xxonoutofmemoryerrorkill--9-p">-XX:OnOutOfMemoryError=&ldquo;kill -9 %p&rdquo;</h1>
<h1 id="executing-binsh--c-kill--9-">Executing /bin/sh -c &ldquo;kill -9 *****&rdquo;&hellip;</h1>
<ol start="2">
<li>Spark cluster worker node shutdown</li>
</ol>
<p>Worker nodes worked well until driver shutdown. Error log:</p>
<p>ERROR YarnCoarseGrainedExecutorBackend: Executor self-exiting due to : Driver ip-<em><strong>-</strong></em>-<em><strong>-</strong></em>.ec2.internal:***** disassociated! Shutting down.
INFO MemoryStore: MemoryStore cleared
INFO BlockManager: BlockManager stopped
ERROR CoarseGrainedExecutorBackend: RECEIVED SIGNAL TERM</p>
<p>Analysis</p>
<ol>
<li>Look up driver log</li>
</ol>
<p>This is a driver OOM problem. We need to figure out what caused the driver OOM.</p>
<p>INFO UnifiedMemoryManager: Will not store broadcast_1159 as the required space (6290408084 bytes) exceeds our memory limit (4923378892 bytes)
WARN MemoryStore: Not enough space to cache broadcast_1159 in memory! (computed 3.9 GiB so far)
INFO MemoryStore: Memory use = 2.4 GiB (blocks) + 1024.0 KiB (scratch space shared across 1 tasks(s)) = 2.4 GiB. Storage limit = 4.6 GiB.
WARN BlockManager: Persisting block broadcast_1159 to disk instead.</p>
<p>The size of broadcast_1159 rdd is around 6G, however the free driver memory is only 4.58G, causing the error.
2. Look up the code</p>
<p>There’s a broadcast variable whose size is related to dafaframe row count during overwriting the out-of-date data:</p>
<p>marker = update_df.select(update_df.<!-- raw HTML omitted -->.alias(&lsquo;purge_key&rsquo;))
joined = base.join(sfunc.broadcast(marker), base.<!-- raw HTML omitted --> == marker.purge_key, &rsquo;left_outer&rsquo;)
purged = joined.where(joined.purge_key.isNull()).drop(&lsquo;purge_key&rsquo;)</p>
<p>It’s kind of merge upsert process:</p>
<ol>
<li>
<p>Look up the id from dataframe
2.1 If id exists, update the row of data with new one.
2.2 If id doesn’t exist, insert a new row of data
Learned</p>
<p>Be careful with the size of broadcast variable, especially when their size is growing or fluctuating. Make sure that you have monitoring for the size and it’ll not exceed the driver momory limit.
Merge upsert can be better supported by delta lake. Try delta lake if necessary.
Demo code:</p>
</li>
</ol>
<p>base.alias(&lsquo;base&rsquo;) <br>
.merge(updates.alias(&lsquo;updates&rsquo;), &lsquo;base.<!-- raw HTML omitted --> ==updates.<!-- raw HTML omitted -->&rsquo;) <br>
.whenMatchedUpdateAll() <br>
.whenNotMatchedInsertAll() <br>
.execute()</p>

</article>

                
    
    
        A blog since 2023 | Made by <a href="https://gohugo.io/">hugo</a> | Host on <a href="https://www.cloudflare.com/">cloudflare</a>
    


            </div>
        </main>
    </body>
</html>
